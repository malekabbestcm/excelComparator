name: Deploy to GCE VM

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: vm
    env:
      USE_GCLOUD: ${{ vars.USE_GCLOUD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: excel-comparison/package-lock.json

      - name: Install dependencies
        working-directory: excel-comparison
        run: |
          if [ -f package-lock.json ]; then
            npm ci || npm install
          else
            npm install
          fi

      - name: Build
        working-directory: excel-comparison
        run: npm run build

      - name: Archive build
        run: tar -C excel-comparison -czf nuxt-output.tar.gz .output

      - name: Prepare SSH key
        if: env.USE_GCLOUD != 'true'
        shell: bash
        run: |
          mkdir -p ~/.ssh
          printf "%s" "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Auth to Google Cloud
        if: env.USE_GCLOUD == 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        if: env.USE_GCLOUD == 'true'
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          install_components: beta
          export_default_credentials: true

      - name: Copy build to VM (gcloud)
        if: env.USE_GCLOUD == 'true'
        run: |
          gcloud compute scp nuxt-output.tar.gz ${{ secrets.VM_USER }}@${{ secrets.GCE_INSTANCE }}:~/nuxt-output.tar.gz --zone=${{ secrets.GCE_ZONE }} --quiet

      - name: Copy build to VM (SSH)
        if: env.USE_GCLOUD != 'true'
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          port: ${{ secrets.VM_SSH_PORT }}
          key_path: ~/.ssh/deploy_key
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          source: nuxt-output.tar.gz
          target: ~/nuxt-output.tar.gz

      - name: Deploy on VM (gcloud)
        if: env.USE_GCLOUD == 'true'
        run: |
          gcloud compute ssh ${{ secrets.VM_USER }}@${{ secrets.GCE_INSTANCE }} --zone=${{ secrets.GCE_ZONE }} --quiet --command '
            set -e
            RELEASE_SHA=${{ github.sha }}
            APP_DIR=/var/www/excel-comparison
            USER_APP_DIR=$HOME/apps/excel-comparison
            if sudo -n true 2>/dev/null; then
              RELEASE=${APP_DIR}/releases/${RELEASE_SHA}
              CURRENT=${APP_DIR}/current
              sudo mkdir -p ${RELEASE}
              sudo mv ~/nuxt-output.tar.gz ${RELEASE}/nuxt-output.tar.gz
              sudo tar -xzf ${RELEASE}/nuxt-output.tar.gz -C ${RELEASE}
              sudo rm ${RELEASE}/nuxt-output.tar.gz
              if ! command -v node >/dev/null 2>&1; then
                curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
                sudo apt-get install -y nodejs
              fi
              echo "N8N_WEBHOOK_URL=${{ secrets.N8N_WEBHOOK_URL }}" | sudo tee ${APP_DIR}/.env >/dev/null
              echo "PORT=${{ secrets.APP_PORT }}" | sudo tee -a ${APP_DIR}/.env >/dev/null
              echo "NODE_ENV=production" | sudo tee -a ${APP_DIR}/.env >/dev/null
              if [ ! -f /etc/systemd/system/excel-comparison.service ]; then
                sudo bash -c 'printf "%s\n" \
                  "[Unit]" \
                  Description=Excel Comparison Node.js Application
                  After=network.target   \
                  "" \
                  "[Service]" \
                  User=${{ secrets.VM_USER }} 
                  WorkingDirectory=/var/www/excel-comparison/current # This should point to your 'current' symlink
                  ExecStart=/usr/bin/node /var/www/excel-comparison/current/server/index.mjs # Adjust path to node and your main app file
                  Restart=always
                  Environment=NODE_ENV=production\
                  "" \
                  "[Install]" \
                  "WantedBy=multi-user.target" \
                > /etc/systemd/system/excel-comparison.service'
              fi
              sudo ln -sfn ${RELEASE} ${CURRENT}
            else
              RELEASE=${USER_APP_DIR}/releases/${RELEASE_SHA}
              CURRENT=${USER_APP_DIR}/current
              mkdir -p ${USER_APP_DIR}/releases
              mkdir -p ${RELEASE}
              mkdir -p ${USER_APP_DIR}/logs
              mv ~/nuxt-output.tar.gz ${RELEASE}/nuxt-output.tar.gz
              tar -xzf ${RELEASE}/nuxt-output.tar.gz -C ${RELEASE}
              rm ${RELEASE}/nuxt-output.tar.gz
              printf "%s\n" "N8N_WEBHOOK_URL=${{ secrets.N8N_WEBHOOK_URL }}" > ${USER_APP_DIR}/.env
              printf "%s\n" "PORT=${{ secrets.APP_PORT }}" >> ${USER_APP_DIR}/.env
              printf "%s\n" "NODE_ENV=production" >> ${USER_APP_DIR}/.env
              ln -sfn ${RELEASE} ${CURRENT}
              if command -v node >/dev/null 2>&1; then
                nohup /usr/bin/node ${CURRENT}/.output/server/index.mjs > ${USER_APP_DIR}/logs/app.log 2>&1 & echo $! > ${USER_APP_DIR}/app.pid
              else
                echo "Node.js is not installed and sudo is not available; please install Node or grant admin."
                exit 1
              fi
            fi
          '
      - name: Restart service (gcloud)
        if: env.USE_GCLOUD == 'true'
        run: |
          gcloud compute ssh ${{ secrets.VM_USER }}@${{ secrets.GCE_INSTANCE }} --zone=${{ secrets.GCE_ZONE }} --quiet --command '
            sudo systemctl daemon-reload
            sudo systemctl enable excel-comparison
            sudo systemctl restart excel-comparison
            sudo systemctl status --no-pager excel-comparison || true
          '

      - name: Deploy on VM (SSH)
        if: env.USE_GCLOUD != 'true'
        uses: appleboy/ssh-action@v1
        env:
          N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
          APP_PORT: ${{ secrets.APP_PORT }}
          COMMIT_SHA: ${{ github.sha }}
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          port: ${{ secrets.VM_SSH_PORT }}
          key_path: ~/.ssh/deploy_key
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            set -e
            APP_DIR=/var/www/excel-comparison
            USER_APP_DIR=$HOME/apps/excel-comparison
            RELEASE_SHA=${COMMIT_SHA}
            if sudo -n true 2>/dev/null; then
              RELEASE=${APP_DIR}/releases/${RELEASE_SHA}
              CURRENT=${APP_DIR}/current
              sudo mkdir -p ${RELEASE}
              sudo mv ~/nuxt-output.tar.gz ${RELEASE}/nuxt-output.tar.gz
              sudo tar -xzf ${RELEASE}/nuxt-output.tar.gz -C ${RELEASE}
              sudo rm ${RELEASE}/nuxt-output.tar.gz
              if ! command -v node >/dev/null 2>&1; then
                curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
                sudo apt-get install -y nodejs
              fi
              echo "N8N_WEBHOOK_URL=${N8N_WEBHOOK_URL}" | sudo tee ${APP_DIR}/.env >/dev/null
              echo "PORT=${APP_PORT}" | sudo tee -a ${APP_DIR}/.env >/dev/null
              echo "NODE_ENV=production" | sudo tee -a ${APP_DIR}/.env >/dev/null
              # Corrected check for systemd service file existence (if intended)
              if [ -f "/etc/systemd/system/excel-comparison.service" ]; then
                # Your existing logic related to the service if it exists
                sudo ln -sfn "$RELEASE" "$CURRENT"
                sudo systemctl daemon-reload
                sudo systemctl enable excel-comparison
                sudo systemctl restart excel-comparison
              else
                RELEASE="$USER_APP_DIR/releases/$RELEASE_SHA"
                CURRENT="$USER_APP_DIR/current"
                mkdir -p "$USER_APP_DIR/releases"
                mkdir -p "$RELEASE"
                mkdir -p "$USER_APP_DIR/logs"
                mv ~/nuxt-output.tar.gz "$RELEASE/nuxt-output.tar.gz"
                tar -xzf "$RELEASE/nuxt-output.tar.gz" -C "$RELEASE"
                rm "$RELEASE/nuxt-output.tar.gz"
                printf "%s\n" "N8N_WEBHOOK_URL=***" > "$USER_APP_DIR/.env"
                printf "%s\n" "PORT=" >> "$USER_APP_DIR/.env"
                printf "%s\n" "NODE_ENV=production" >> "$USER_APP_DIR/.env"
                ln -sfn "$RELEASE" "$CURRENT"

                # --- Add Node.js installation here ---
                if ! command -v node >/dev/null 2>&1; then
                  echo "Node.js not found. Installing..."
                  # Example for Debian/Ubuntu, adjust for your OS
                  sudo apt-get update
                  sudo apt-get install -y nodejs npm
                  if [ $? -ne 0 ]; then
                    echo "Failed to install Node.js. Exiting."
                    exit 1
                  fi
                fi
                # --- End Node.js installation ---

                # Now that Node.js is confirmed to be installed, start the application
                nohup /usr/bin/node "$CURRENT/server/index.mjs" > "$USER_APP_DIR/logs/app.log" 2>&1 & echo $! > "$USER_APP_DIR/app.pid"
              fi

              sudo ln -sfn ${RELEASE} ${CURRENT}
            else
              RELEASE=${USER_APP_DIR}/releases/${RELEASE_SHA}
              CURRENT=${USER_APP_DIR}/current
              mkdir -p ${USER_APP_DIR}/releases
              mkdir -p ${RELEASE}
              mkdir -p ${USER_APP_DIR}/logs
              mv ~/nuxt-output.tar.gz ${RELEASE}/nuxt-output.tar.gz
              tar -xzf ${RELEASE}/nuxt-output.tar.gz -C ${RELEASE}
              rm ${RELEASE}/nuxt-output.tar.gz
              printf "%s\n" "N8N_WEBHOOK_URL=${N8N_WEBHOOK_URL}" > ${USER_APP_DIR}/.env
              printf "%s\n" "PORT=${APP_PORT}" >> ${USER_APP_DIR}/.env
              printf "%s\n" "NODE_ENV=production" >> ${USER_APP_DIR}/.env
              ln -sfn ${RELEASE} ${CURRENT}
              if command -v node >/dev/null 2>&1; then
                nohup /usr/bin/node ${CURRENT}/.output/server/index.mjs > ${USER_APP_DIR}/logs/app.log 2>&1 & echo $! > ${USER_APP_DIR}/app.pid
              else
                echo "Node.js is not installed and sudo is not available; please install Node or grant admin."
                exit 1
              fi
            fi
      - name: Restart service (SSH)
        if: env.USE_GCLOUD != 'true'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          port: ${{ secrets.VM_SSH_PORT }}
          key_path: ~/.ssh/deploy_key
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            sudo systemctl daemon-reload
            sudo systemctl enable excel-comparison
            sudo systemctl restart excel-comparison
            sudo systemctl status --no-pager excel-comparison || true
