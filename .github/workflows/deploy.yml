name: Deploy to GCE VM

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: excel-comparison/package-lock.json

      - name: Install dependencies
        working-directory: excel-comparison
        run: npm ci

      - name: Build
        working-directory: excel-comparison
        run: npm run build

      - name: Archive build
        run: tar -C excel-comparison -czf nuxt-output.tar.gz .output

      - name: Copy build to VM
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          port: ${{ secrets.VM_SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: nuxt-output.tar.gz
          target: /var/www/excel-comparison/releases/${{ github.sha }}

      - name: Deploy on VM
        uses: appleboy/ssh-action@v1
        env:
          N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
          APP_PORT: ${{ secrets.APP_PORT }}
          COMMIT_SHA: ${{ github.sha }}
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          port: ${{ secrets.VM_SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            APP_DIR=/var/www/excel-comparison
            RELEASE=${APP_DIR}/releases/${COMMIT_SHA}
            CURRENT=${APP_DIR}/current
            sudo mkdir -p ${APP_DIR}/releases
            sudo tar -xzf ${RELEASE}/nuxt-output.tar.gz -C ${RELEASE}
            sudo rm ${RELEASE}/nuxt-output.tar.gz
            if ! command -v node >/dev/null 2>&1; then
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            echo "N8N_WEBHOOK_URL=${N8N_WEBHOOK_URL}" | sudo tee ${APP_DIR}/.env >/dev/null
            echo "PORT=${APP_PORT}" | sudo tee -a ${APP_DIR}/.env >/dev/null
            echo "NODE_ENV=production" | sudo tee -a ${APP_DIR}/.env >/dev/null
            if [ ! -f /etc/systemd/system/excel-comparison.service ]; then
              sudo tee /etc/systemd/system/excel-comparison.service >/dev/null <<UNIT
            [Unit]
            Description=Excel Comparison Nuxt 3
            After=network.target


            [Service]
            Type=simple
            WorkingDirectory=${APP_DIR}/current
            ExecStart=/usr/bin/node ${APP_DIR}/current/server/index.mjs
            Restart=always
            EnvironmentFile=${APP_DIR}/.env

            [Install]
            WantedBy=multi-user.target
            UNIT
                        fi
                        sudo ln -sfn ${RELEASE} ${CURRENT}
                        sudo systemctl daemon-reload
                        sudo systemctl enable excel-comparison
                        sudo systemctl restart excel-comparison
